#@ load("@ytt:template", "template")
#@ load("@ytt:overlay", "overlay")

#@ configuration = "Release"
#@ androidABIs = [ 'armeabi-v7a', 'arm64-v8a', 'x86', 'x86_64' ]

#@ def checkoutCode():
name: Checkout code
uses: actions/checkout@v2
with:
  submodules: recursive
#@ end

#@ def checkCache(key):
name: Check cache
id: check-cache
uses: actions/cache@v2
with:
  path: ./wrappers/build/**
  key: #@ key
#@ end

#@ def cacheCondition():
#@overlay/match missing_ok=True
if: steps.check-cache.outputs.cache-hit != 'true'
#@ end

#@ def setupVcpkg():
name: Setup Vcpkg
uses: ./.github/actions/get-vcpkg-prebuilt
#@ end

#@ def downloadNDK():
name: Download NDK
uses: nttld/setup-ndk@v1
id: download-ndk
with:
  ndk-version: r21d
#@ end

#@ def setupNDKVariables():
name: Setup NDK Environment
run: |
    echo "ANDROID_NDK_ROOT=${{ steps.download-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
    echo "ANDROID_NDK_HOME=${{ steps.download-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
    echo "ANDROID_NDK=${{ steps.download-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
#@ end

#@ def buildWrappers(cmd, outputVar, intermediateSteps = []):
#@ actualCommand = cmd + " --configuration=" + configuration + " -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=${{ github.event_name == 'pull_request' && 'ON' || 'OFF' }}"
#@ cacheKey = outputVar + "-" + configuration + "-${{ github.event_name == 'pull_request' && 'ON' || 'OFF' }}-${{hashFiles('./wrappers/**')}}"

steps:
  - #@ checkoutCode()
  - #@ checkCache(cacheKey)
#@ for step in intermediateSteps:
  - #@ template.replace([overlay.apply(step, cacheCondition())])
#@ end
  - name: Build wrappers
    run: #@ actualCommand
    _: #@ template.replace(cacheCondition())
#@ end

---
name: build and test
on:
  push:
    branches:
      - main
      - master
  pull_request:
jobs:
  build-wrappers-macos:
    runs-on: macos-latest
    name: Build macOS wrappers
    _: #@ template.replace(buildWrappers("./wrappers/build-macos.sh", "wrappers-macos"))
  build-wrappers-ios:
    runs-on: macos-latest
    name: Build iOS wrappers
    _: #@ template.replace(buildWrappers("./wrappers/build-ios.sh", "wrappers-ios"))
  build-wrappers-linux:
    runs-on: ubuntu-20.04
    name: Build Linux wrappers
    _: #@ template.replace(buildWrappers("./wrappers/build.sh", "wrappers-linux"))
  build-wrappers-android:
    runs-on: ubuntu-20.04
    name: Build Android wrappers
    strategy:
      matrix:
        arch: #@ androidABIs
    _: #@ template.replace(buildWrappers("./wrappers/build-android.sh --ARCH=${{ matrix.arch }}", "wrappers-android-${{ matrix.arch }}", [downloadNDK(), setupNDKVariables()]))