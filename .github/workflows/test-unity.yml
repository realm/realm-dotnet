name: test-unity
"on":
  workflow_call:
    inputs:
      version:
        type: string
        required: true
      os:
        type: string
        required: true
      platform:
        type: string
        required: true
      settings:
        type: string
        required: true
env:
  REALM_DISABLE_ANALYTICS: true
  DOTNET_NOLOGO: true
jobs:
  build-tests:
    runs-on:
    - unity
    - ${{ inputs.os }}
    name: Build Unity ${{ inputs.os }}
    timeout-minutes: 30
    steps:
    - name: Fetch Unity Package
      uses: actions/download-artifact@v2
      with:
        name: io.realm.unity-${{ inputs.version }}.tgz
        path: Realm/Realm.Unity
    - name: Fetch Unity Tests
      uses: actions/download-artifact@v2
      with:
        name: UnityTests
        path: Tests/Tests.Unity
    - name: Build Unity Tests
      run: |
        unity-editor -runTests -batchmode -projectPath ${{ github.workspace }}/Tests/Tests.Unity -testPlatform Standalone${{ inputs.platform }} -testSettingsFile ${{ github.workspace }}/Tests/Tests.Unity/.TestConfigs/${{ inputs.settings }}.json -logFile ${{ inputs.os == 'windows' && 'build.log' || '-'}}
        ${{ inputs.os == 'windows' && 'cat build.log' || ''}}
    - name: Store artifacts for UnityTestsRunner.${{ inputs.os }}
      uses: actions/upload-artifact@v2
      with:
        name: UnityTestsRunner.${{ inputs.os }}
        path: ${{ github.workspace }}/Tests/Tests.Unity/Player_Standalone${{ inputs.platform }}_${{ inputs.settings }}/
        retention-days: ${{ github.event_name != 'pull_request' && 30 || 1 }}
  run-tests-windows:
    runs-on: windows-latest
    name: Unity Windows
    timeout-minutes: 30
    needs:
    - build-tests
    steps:
    - name: Download Test Runner
      uses: actions/download-artifact@v2
      with:
        name: UnityTestsRunner.windows
        path: TestRunner
    - name: Run Tests
      run: |
        tree
        ${{ github.workspace }}\TestRunner\PlayerWithTests.exe -logFile test.log
        cat test.log
      shell: powershell
