name: main
"on":
  push:
    branches:
    - main
    - master
  pull_request: null
jobs:
  code-coverage:
    runs-on: ubuntu-latest
    name: Code Coverage
    steps:
    - name: Disable Analytics
      run: |
        echo "REALM_DISABLE_ANALYTICS=true" >> $GITHUB_ENV
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        submodules: false
        ref: ${{ github.event.pull_request.head.sha }}
    - name: Register csc problem matcher
      run: echo "::add-matcher::.github/problem-matchers/csc.json"
    - name: Register msvc problem matcher
      run: echo "::add-matcher::.github/problem-matchers/msvc.json"
    - name: Download all artifacts
      uses: dawidd6/action-download-artifact@v2
      with:
        workflow: main.yml
        run_number: 1130
        workflow_conclusion: cancelled
        path: ${{ github.workspace }}/Realm/packages/
    - uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 5.0.x
    - name: Setup Coverlet & Report Generator
      run: |
        dotnet tool install coverlet.console --tool-path tools
        dotnet tool install dotnet-reportgenerator-globaltool --tool-path tools
        echo "${{ github.workspace }}/tools" >> $GITHUB_PATH
    - name: Publish Tests/Realm.Tests
      run: dotnet publish Tests/Realm.Tests -c Debug -f net5.0 -r 'linux-x64' -p:RestoreConfigFile=Tests/Test.NuGet.Config -p:UseRealmNupkgsWithVersion=10.3.1-PR-2581.1130 -p:AdditionalFrameworks=net5.0 --no-self-contained
    - name: Run the tests
      run: ./tools/coverlet ${{ github.workspace }}/Tests/Realm.Tests/bin/Debug/net5.0/linux-x64/publish/ -t ./Tests/Realm.Tests/bin/Debug/net5.0/linux-x64/publish/Realm.Tests -a "--labels=After" -f lcov -o ./report.lcov
    - name: Generate Html Report
      run: ./tools/reportgenerator -reports:"./report.lcov" -targetdir:"./coveragereport" -reporttypes:Html
    - name: Upload Coverage Report
      uses: actions/upload-artifact@v2
      with:
        name: coverage-report
        path: ${{ github.workspace }}/coveragereport/**
        retention-days: 30
