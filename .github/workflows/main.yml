name: main
"on":
  push:
    branches:
    - main
    - master
  pull_request: null
env:
  REALM_DISABLE_ANALYTICS: true
  DOTNET_NOLOGO: true
jobs:
  build-wrappers-ios-device:
    runs-on: macos-latest
    name: Wrappers iOS Device
    timeout-minutes: 90
    steps:
    - name: Cleanup Workspace
      run: rm -rf "${{ github.workspace }}/*"
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        submodules: recursive
        ref: ${{ github.event.pull_request.head.sha }}
    - name: Check cache
      id: check-cache
      uses: actions/cache@v2
      with:
        path: ./wrappers/build/**
        key: wrappers-ios-device-Release-${{hashFiles('./wrappers/**')}}
    - name: Build wrappers
      run: pwsh ./wrappers/build-ios.ps1 Device -SkipXCFramework -Configuration Release -EnableLTO
      if: steps.check-cache.outputs.cache-hit != 'true'
    - name: Store artifacts for wrappers-ios-device
      uses: actions/upload-artifact@v2
      with:
        name: wrappers-ios-device
        path: ${{ github.workspace }}/wrappers/cmake/**/realm-wrappers.framework
        retention-days: 1
  build-wrappers-ios-simulator:
    runs-on: macos-latest
    name: Wrappers iOS Simulator
    timeout-minutes: 90
    steps:
    - name: Cleanup Workspace
      run: rm -rf "${{ github.workspace }}/*"
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        submodules: recursive
        ref: ${{ github.event.pull_request.head.sha }}
    - name: Check cache
      id: check-cache
      uses: actions/cache@v2
      with:
        path: ./wrappers/build/**
        key: wrappers-ios-simulator-Release-${{hashFiles('./wrappers/**')}}
    - name: Build wrappers
      run: pwsh ./wrappers/build-ios.ps1 Device -SkipXCFramework -Configuration Release -EnableLTO
      if: steps.check-cache.outputs.cache-hit != 'true'
    - name: Store artifacts for wrappers-ios-simulator
      uses: actions/upload-artifact@v2
      with:
        name: wrappers-ios-simulator
        path: ${{ github.workspace }}/wrappers/cmake/**/realm-wrappers.framework
        retention-days: 1
  build-wrappers-ios:
    runs-on: macos-latest
    name: Wrappers iOS XCframework
    needs:
    - build-wrappers-ios-device
    - build-wrappers-ios-simulator
    timeout-minutes: 90
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        submodules: recursive
        ref: ${{ github.event.pull_request.head.sha }}
    - name: Check cache
      id: check-cache
      uses: actions/cache@v2
      with:
        path: ./wrappers/build/**
        key: wrappers-ios-Release-${{hashFiles('./wrappers/**')}}
    - name: Fetch device framework
      uses: actions/download-artifact@v2
      with:
        name: wrappers-ios-device
        path: wrappers/cmake
    - name: Fetch simulator framework
      uses: actions/download-artifact@v2
      with:
        name: wrappers-ios-simulator
        path: wrappers/cmake
    - name: Create xcframework
      run: |
        $build_directory = "{{ github.workspace }}/wrappers/cmake/iOS"
        $install_prefix = "{{ github.workspace }}/wrappers/build"
        $xcframework_path = "$install_prefix/iOS/Release/realm-wrappers.xcframework"
        xcodebuild -create-xcframework -framework $build_directory/src/Release-iphonesimulator/realm-wrappers.framework -framework $build_directory/src/Release-iphoneos/realm-wrappers.framework -output "$xcframework_path"
      shell: powershell
      if: steps.check-cache.outputs.cache-hit != 'true'
    - name: Store artifacts for wrappers-ios
      uses: actions/upload-artifact@v2
      with:
        name: wrappers-ios
        path: ${{ github.workspace }}/wrappers/build/**
        retention-days: 1
